name: ci

on:
  push:
  pull_request:

jobs:
  build-and-boot:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: "1.22.x"

      - name: Install QEMU + ISO tooling
        run: |
          sudo apt-get update
          sudo apt-get install -y qemu-system-x86 grub-pc-bin xorriso mtools

      - name: Ensure a kernel is available
        run: |
          set -eux
          sudo apt-get update
          sudo apt-get install -y linux-image-generic
          mkdir -p build
          sudo cp -L "$(ls /boot/vmlinuz-*generic* | tail -n 1)" build/vmlinuz
          sudo chmod a+r build/vmlinuz
          file build/vmlinuz

      - name: Build init + initramfs (u-root + uinit)
        run: |
          set -eux
          CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -trimpath -ldflags="-s -w" -o build/goos-init ./cmd/init

          # Pin u-root
          go install github.com/u-root/u-root@v0.15.0

          # Build initramfs:
          # - include u-root init command so /init exists
          # - install our binary into /bbin
          # - run it as uinit
          GO111MODULE=on u-root -build=bb -format=cpio -o build/initramfs.cpio \
            -files "build/goos-init:bbin/goos-init" \
            -uinitcmd="/bbin/goos-init" \
            -defaultsh=gosh \
            github.com/u-root/u-root/cmds/core/init \
            github.com/u-root/u-root/cmds/core/gosh \
            github.com/u-root/u-root/cmds/core/ip \
            github.com/u-root/u-root/cmds/core/dhclient \
            github.com/u-root/u-root/cmds/core/ls \
            github.com/u-root/u-root/cmds/core/cat \
            github.com/u-root/u-root/cmds/core/mkdir

      - name: Build GRUB ISO
        run: |
          set -eux
          mkdir -p build/iso/boot/grub
          cp -f build/vmlinuz build/iso/boot/vmlinuz
          cp -f build/initramfs.cpio build/iso/boot/initramfs.cpio
          cp -f assets/grub/grub.cfg build/iso/boot/grub/grub.cfg
          # grub-mkrescue relies on xorriso. :contentReference[oaicite:4]{index=4}
          grub-mkrescue -o build/goos.iso build/iso

      - name: Boot smoke test from ISO (expects READY)
        run: |
          set -euxo pipefail

          # Run QEMU in background with TCG (KVM not available on GitHub Actions)
          qemu-system-x86_64 -m 1024 -nographic -accel tcg \
            -kernel build/vmlinuz \
            -initrd build/initramfs.cpio \
            -append "console=ttyS0 goos.shell=0" \
            > build/boot.log 2>&1 &
          QEMU_PID=$!

          # Wait up to 120s for READY
          for i in $(seq 1 120); do
            if grep -q READY build/boot.log 2>/dev/null; then
              echo "READY found, stopping QEMU"
              kill $QEMU_PID 2>/dev/null || true
              wait $QEMU_PID 2>/dev/null || true
              cat build/boot.log
              exit 0
            fi
            if ! kill -0 $QEMU_PID 2>/dev/null; then
              echo "QEMU exited unexpectedly"
              cat build/boot.log
              exit 1
            fi
            sleep 1
          done

          echo "Timeout waiting for READY"
          kill $QEMU_PID 2>/dev/null || true
          cat build/boot.log
          exit 1


      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: goos-iso
          path: |
            build/goos.iso
            build/vmlinuz
            build/initramfs.cpio
            build/boot.log
